<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>La Sciampista Â· Assistente AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body {
        margin: 0; padding: 0;
        height: 100%; width: 100%;
        background: #f7efe9; color: #1f1f1f;
        font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      body { display: flex; flex-direction: column; overflow: hidden; }

      header {
        padding: 10px 14px;
        font-size: .8rem;
        letter-spacing: .12em;
        text-transform: uppercase;
        color: #6a5b54;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255,255,255,0.6);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        z-index: 1000;
      }
      header .brand { color: #b47a72; font-weight: 600; }

      .app-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      .frame-9-16 {
        position: relative;
        width: 100vw;
        max-width: 540px;
        aspect-ratio: 9/16;
        overflow: hidden;
        background: #000;
      }

      #heygen-streaming-embed {
        position: absolute !important;
        inset: 0 !important;
        width: 100% !important;
        height: 100% !important;
        border: none !important;
        border-radius: 0 !important;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
      #heygen-streaming-embed.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transition: opacity .25s ease-out;
      }
      #heygen-streaming-container,
      #heygen-streaming-container iframe {
        width: 100% !important;
        height: 100% !important;
        border: 0 !important;
      }

      .hint-mobile {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        text-align: center;
        font-size: .75rem;
        color: #fff;
        background: rgba(0,0,0,0.35);
        padding: 8px 10px;
        border-radius: 12px;
        margin: 0 10px;
        z-index: 70;
      }
      .hint-mobile strong { font-weight: 700; }

      .pill {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 80;
        font-size: .75rem;
        color: #fff;
        background: rgba(0,0,0,0.35);
        padding: 6px 10px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        user-select: none;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #888;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.12) inset;
      }
      .dot.on { background: #46d369; }

      #presence-video, #presence-canvas {
        position: absolute;
        width: 1px;
        height: 1px;
        opacity: 0;
        pointer-events: none;
        left: -9999px;
        top: -9999px;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="brand">La Sciampista Â· AI</div>
      <div class="hint">Consulente capelli naturale</div>
    </header>

    <div class="app-wrapper">
      <div class="frame-9-16" id="frame">
        <div class="pill" aria-live="polite">
          <span class="dot" id="presenceDot"></span>
          <span id="presenceText">In attesa di presenzaâ€¦</span>
        </div>

        <div class="pill" style="top:44px" aria-live="polite">
          <span id="debugText">initâ€¦</span>
        </div>

        <div class="hint-mobile" id="hintMobile">
          <strong>Avvicinati</strong> e lâ€™avatar si attiva automaticamente.<br/>
          Al primo avvio potrebbe essere necessario <strong>toccare lo schermo</strong> per abilitare il microfono.
        </div>

        <video id="presence-video" playsinline muted></video>
        <canvas id="presence-canvas"></canvas>
      </div>
    </div>

    <script>
      (function(){
        const host="https://labs.heygen.com";
        const url=host+"/guest/streaming-embed?share=eyJxdWFsaXR5IjoiaGlnaCIsImF2YXRhck5hbWUiOiJLYXR5YV9Qcm9mZXNzaW9uYWxMb29rX3B1%0D%0AYmxpYyIsInByZXZpZXdJbWciOiJodHRwczovL2ZpbGVzMi5oZXlnZW4uYWkvYXZhdGFyL3YzLzM0%0D%0AOGRkZjUwM2M2NTRiOWJiYmI4YmVhOWY5MjEwZWFkXzU1ODcwL3ByZXZpZXdfdGFyZ2V0LndlYnAi%0D%0ALCJuZWVkUmVtb3ZlQmFja2dyb3VuZCI6dHJ1ZSwia25vd2xlZGdlQmFzZUlkIjoiY2E3M2VmNmY2%0D%0AOTdhNGFhMTgzZGM1MzZkY2EyMDY3YmYiLCJ1c2VybmFtZSI6ImZiNDBjZGI1NjdlZjRjMTg5MDM4%0D%0ANDkwODI5YzIwZTZmIn0%3D&inIFrame=1";

        const frame = document.getElementById("frame");

        // ==== Embed ====
        const wrapDiv=document.createElement("div");
        wrapDiv.id="heygen-streaming-embed";
        const container=document.createElement("div");
        container.id="heygen-streaming-container";

        // iframe creator (serve per "reset sessione")
        function createIframe(){
          const ifr=document.createElement("iframe");
          ifr.allowFullscreen=false;
          ifr.title="La Sciampista AI";
          ifr.role="dialog";
          ifr.allow="microphone; camera; autoplay";
          ifr.src=url;
          return ifr;
        }

        let iframe = createIframe();
        container.appendChild(iframe);
        wrapDiv.appendChild(container);
        frame.appendChild(wrapDiv);

        // ==== UI refs ====
        const videoEl = document.getElementById("presence-video");
        const canvasEl = document.getElementById("presence-canvas");
        const ctx = canvasEl.getContext("2d", { willReadFrequently: true });

        const presenceDot = document.getElementById("presenceDot");
        const presenceText = document.getElementById("presenceText");
        const hintMobile = document.getElementById("hintMobile");
        const debugText = document.getElementById("debugText");

        function setPresenceUI(on){
          presenceDot.classList.toggle("on", on);
          presenceText.textContent = on ? "Presenza rilevata Â· Attivo chatâ€¦" : "In attesa di presenzaâ€¦";
        }

        function showHeyGen(){
          wrapDiv.classList.add("show");
          hintMobile.style.display = "none";
        }

        function hideHeyGen(){
          wrapDiv.classList.remove("show");
          hintMobile.style.display = "block";
        }

        // ====== OPZIONE RESET SESSIONE ======
        // Se true: quando la persona va via, ricarica l'iframe (sessione â€œpulitaâ€ per il prossimo)
        const RESET_IFRAME_ON_ABSENCE = true;

        function resetHeyGenSession(){
          try {
            container.removeChild(iframe);
          } catch(_) {}
          iframe = createIframe();
          container.appendChild(iframe);
        }

        function activateHeyGen(){
          showHeyGen();
          try {
            iframe.contentWindow.postMessage({ type: "streaming-embed", action: "show" }, host);
            iframe.contentWindow.postMessage({ type: "streaming-embed", action: "start" }, host);
            iframe.contentWindow.postMessage({ type: "streaming-embed", action: "open" }, host);
          } catch(_) {}
          try {
            iframe.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
          } catch(_) {}
        }

        // Tap manuale = sblocca sempre
        frame.addEventListener("click", () => showHeyGen(), { passive: true });

        // ===============================
        // FACE DETECTION + PRESENCE LOCK
        // ===============================
        const faceSupported = ("FaceDetector" in window);
        let faceDetector = null;

        // Stato presenza
        let isActive = false;
        let lastSeenTs = 0;
        let faceConsecutiveHits = 0;

        // Tuning (qui Ã¨ dove abbiamo sistemato il tuo problema)
        const FACE_SCAN_EVERY_MS = 300;
        const FACE_REQUIRED_HITS = 2;

        // <<<<< QUI: quanto tempo deve passare senza volto per tornare in attesa >>>>>
        const ABSENCE_TIMEOUT_MS = 1500; // 1.5s (metti 1000 se lo vuoi ancora piÃ¹ rapido)

        // ===============================
        // MOTION fallback (se FaceDetector manca)
        // ===============================
        let lastImageData = null;
        let motionConsecutiveHits = 0;

        const SAMPLE_W = 240;
        const SAMPLE_H = 180;
        const DIFF_THRESHOLD = 6;
        const MOTION_RATIO = 0.0035;
        const MOTION_REQUIRED_HITS = 2;

        function setActive(reason){
          isActive = true;
          lastSeenTs = Date.now();
          setPresenceUI(true);
          activateHeyGen();
          if (debugText) debugText.textContent = `ACTIVE âœ… (${reason})`;
        }

        function setIdle(reason){
          isActive = false;
          faceConsecutiveHits = 0;
          motionConsecutiveHits = 0;
          setPresenceUI(false);
          hideHeyGen();

          if (RESET_IFRAME_ON_ABSENCE) {
            resetHeyGenSession();
          }

          if (debugText) debugText.textContent = `IDLE ðŸ’¤ (${reason})`;
        }

        async function startCamera(){
          try {
            if (debugText) debugText.textContent = "camera: richiesta permessoâ€¦";

            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
              audio: false
            });

            videoEl.srcObject = stream;
            await videoEl.play();

            canvasEl.width = SAMPLE_W;
            canvasEl.height = SAMPLE_H;

            if (faceSupported) {
              faceDetector = new FaceDetector({ fastMode: true, maxDetectedFaces: 1 });
              if (debugText) debugText.textContent = "FaceDetector: ON";
            } else {
              if (debugText) debugText.textContent = "FaceDetector: OFF (fallback motion)";
            }

            tick();

          } catch (err) {
            setPresenceUI(false);
            presenceText.textContent = "Camera non disponibile Â· Tocca per avviare";
            if (debugText) debugText.textContent = "camera: ERRORE/NEGATA";
            showHeyGen();
          }
        }

        let lastScanTs = 0;

        async function tick(){
          const now = Date.now();

          // Se siamo ACTIVE: controlliamo solo se Ã¨ sparito il volto da troppo
          if (isActive) {
            // Aggiorna lastSeenTs se vede ancora la faccia (o motion in fallback)
            const saw = await detectPresenceOnce(now);

            if (saw) lastSeenTs = now;

            const absentFor = now - lastSeenTs;
            if (absentFor >= ABSENCE_TIMEOUT_MS) {
              setIdle("assenza");
            } else {
              if (debugText) debugText.textContent = `ACTIVE (absent ${absentFor}ms)`;
            }

            requestAnimationFrame(tick);
            return;
          }

          // Se NON active: cerchiamo di attivare
          if ((now - lastScanTs) >= FACE_SCAN_EVERY_MS) {
            lastScanTs = now;

            const saw = await detectPresenceOnce(now);

            if (saw) {
              faceConsecutiveHits++;
              if (debugText) debugText.textContent = `Detect: âœ… (${faceConsecutiveHits}/${FACE_REQUIRED_HITS})`;
              if (faceConsecutiveHits >= FACE_REQUIRED_HITS) setActive(faceSupported ? "face" : "motion");
            } else {
              faceConsecutiveHits = Math.max(0, faceConsecutiveHits - 1);
              if (debugText) debugText.textContent = `Detect: -- (${faceConsecutiveHits}/${FACE_REQUIRED_HITS})`;
            }
          }

          requestAnimationFrame(tick);
        }

        async function detectPresenceOnce(){
          // Preferisci face detection
          if (faceSupported && faceDetector) {
            try {
              const bmp = await createImageBitmap(videoEl);
              const faces = await faceDetector.detect(bmp);
              bmp.close?.();
              return (faces && faces.length > 0);
            } catch (e) {
              // se FaceDetector fallisce, fallback motion
              faceDetector = null;
              if (debugText) debugText.textContent = "FaceDetector errore â†’ fallback motion";
              return detectMotionOnce();
            }
          }

          // fallback motion
          return detectMotionOnce();
        }

        function detectMotionOnce(){
          if (videoEl.readyState < 2) return false;

          ctx.drawImage(videoEl, 0, 0, SAMPLE_W, SAMPLE_H);
          const imageData = ctx.getImageData(0, 0, SAMPLE_W, SAMPLE_H);

          if (!lastImageData) {
            lastImageData = imageData;
            return false;
          }

          let changed = 0;
          const data = imageData.data;
          const last = lastImageData.data;

          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            const lr = last[i], lg = last[i+1], lb = last[i+2];
            const diff = (Math.abs(r-lr) + Math.abs(g-lg) + Math.abs(b-lb)) / 3;
            if (diff > DIFF_THRESHOLD) changed++;
          }

          const totalSamples = (data.length / 4);
          const ratio = changed / totalSamples;

          lastImageData = imageData;

          const saw = ratio > MOTION_RATIO;
          if (debugText && !faceSupported) debugText.textContent = `Motion ratio: ${ratio.toFixed(4)}`;
          return saw;
        }

        window.addEventListener("load", startCamera);
      })();
    </script>
  </body>
</html>
